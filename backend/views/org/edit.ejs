<div class="ui segment" style="max-width: 800px; margin: 2em auto; padding: 2em;">
  <header style="text-align: center; margin-bottom: 1.5em;">
    <h1 class="ui header dark-teal-text">
      <i class="ui icon edit"></i>
      <div class="content">
        Edit Listing
        <div class="sub header">#<%= props.listing.guid %> &mdash; <%= props.listing.full_name %></div>
      </div>
    </h1>
  </header>

  <% if (props.success) { %>
  <div class="ui success icon message">
    <i class="large check middle aligned icon"></i>
    <div class="content">
      <div class="header">Listing Updated</div>
      <p>"<%= props.listing.full_name %>" has been saved.</p>
    </div>
  </div>
  <% } %>

  <% if (props.error) { %>
  <div class="ui negative message">
    <div class="header">Error</div>
    <p><%= props.error %></p>
  </div>
  <% } %>

  <% var l = props.listing; %>

  <form class="ui form" action="/org/edit/<%= l.guid %>" method="POST" enctype="multipart/form-data">

    <h3 class="ui dividing header">Required</h3>

    <div class="required field">
      <label>Resource Name</label>
      <input type="text" name="full_name" value="<%= l.full_name || '' %>" required>
    </div>

    <div class="required field">
      <label>Category</label>
      <select name="category" required style="width:100%; padding:.67em 1em; border:1px solid rgba(34,36,38,.15); border-radius:.29em; font-size:1em;">
        <option value="">-- Select a category --</option>
        <% if (props.categories) { %>
          <% props.categories.forEach(function(cat) { %>
            <option value="<%= cat %>" <%= l.category === cat ? 'selected' : '' %>><%= cat %></option>
          <% }) %>
        <% } %>
        <option value="__custom">+ Add new category...</option>
      </select>
    </div>

    <div class="field" id="custom-category-field" style="display: none;">
      <label>New Category (format: "Parent: Subcategory")</label>
      <input type="text" name="custom_category" placeholder="e.g. Education: After School Programs">
    </div>

    <div class="required field">
      <label>Description</label>
      <textarea name="description" rows="3" placeholder="Describe the program or services your organization provides" required><%= l.description || '' %></textarea>
    </div>

    <h3 class="ui dividing header">Point Person (Internal Only)</h3>

    <div class="three fields">
      <div class="field">
        <label>Contact Name</label>
        <input type="text" name="contact_name" value="<%= l.contact_name || '' %>">
      </div>
      <div class="field">
        <label>Contact Email</label>
        <input type="email" name="contact_email" value="<%= l.contact_email || '' %>">
      </div>
      <div class="field">
        <label>Contact Phone</label>
        <input type="text" name="contact_phone" value="<%= l.contact_phone || '' %>">
      </div>
    </div>

    <h3 class="ui dividing header">Contact Info</h3>

    <div class="two fields">
      <div class="field">
        <label>Phone</label>
        <input type="text" name="phone_1" value="<%= l.phone_1 || '' %>">
      </div>
      <div class="field">
        <label>Crisis Line</label>
        <input type="text" name="crisis_line_number" value="<%= l.crisis_line_number || '' %>">
      </div>
    </div>

    <div class="two fields">
      <div class="field">
        <label>Website</label>
        <input type="url" name="website" value="<%= l.website || '' %>">
      </div>
      <div class="field">
        <label>Email</label>
        <input type="email" name="program_email" value="<%= l.program_email || '' %>">
      </div>
    </div>

    <h3 class="ui dividing header">Location</h3>

    <div class="field">
      <label>Organization / Location Name</label>
      <input type="text" name="parent_organization" value="<%= l.parent_organization || '' %>">
    </div>

    <div class="field">
      <label>Full Address</label>
      <input type="text" name="full_address" value="<%= l.full_address || '' %>">
      <% if (l.latitude && l.longitude) { %>
        <small style="color: #888;">Current coords: (<%= l.latitude %>, <%= l.longitude %>)</small>
      <% } else { %>
        <small style="color: #c0392b;">No map coordinates yet</small>
      <% } %>
    </div>

    <div class="two fields">
      <div class="field">
        <label>City</label>
        <input type="text" name="city" value="<%= l.city || '' %>">
      </div>
      <div class="field">
        <label>Service Type</label>
        <% var kw = Array.isArray(l.keywords) ? l.keywords.join(',') : (l.keywords || 'In-Person'); %>
        <select class="ui dropdown" name="service_type">
          <option value="In-Person" <%= kw.includes('In-Person') && !kw.includes('Telehealth') ? 'selected' : '' %>>In-Person</option>
          <option value="Online Only" <%= kw.includes('Online Only') ? 'selected' : '' %>>Online Only</option>
          <option value="In-Person,Telehealth" <%= kw.includes('In-Person') && kw.includes('Telehealth') ? 'selected' : '' %>>In-Person + Telehealth</option>
          <option value="Telehealth" <%= kw === 'Telehealth' ? 'selected' : '' %>>Telehealth Only</option>
        </select>
      </div>
    </div>

    <div class="two fields">
      <div class="field">
        <label>Age Group Served</label>
        <select class="ui dropdown" name="age_group">
          <option value="Youth and Adult" <%= (l.age_group || 'Youth and Adult') === 'Youth and Adult' ? 'selected' : '' %>>Youth and Adult</option>
          <option value="Youth" <%= l.age_group === 'Youth' ? 'selected' : '' %>>Youth Only</option>
          <option value="Adult" <%= l.age_group === 'Adult' ? 'selected' : '' %>>Adult Only</option>
        </select>
      </div>
      <div class="field" style="display: flex; align-items: flex-end; padding-bottom: .5em;">
        <div class="ui checkbox">
          <input type="checkbox" name="faith_based" id="faith_based_edit" <%= kw.includes('Faith-Based') ? 'checked' : '' %>>
          <label for="faith_based_edit"><i class="church icon"></i> Faith-Based Organization</label>
        </div>
      </div>
    </div>

    <div class="field">
      <div class="ui checkbox">
        <input type="checkbox" name="re_geocode" id="re_geocode">
        <label for="re_geocode">Re-geocode address (check this if you changed the address)</label>
      </div>
    </div>

    <h3 class="ui dividing header">Building Photo</h3>

    <div class="field">
      <% if (l.image_url) { %>
        <div style="margin-bottom: .75em;">
          <img src="<%= l.image_url %>" alt="Building photo" style="max-width: 300px; max-height: 200px; border-radius: 6px; border: 1px solid #ddd;">
        </div>
        <div class="ui checkbox" style="margin-bottom: .5em;">
          <input type="checkbox" name="remove_image" id="remove_image">
          <label for="remove_image">Remove current photo</label>
        </div>
      <% } %>
      <label><i class="camera icon"></i> <%= l.image_url ? 'Replace' : 'Upload' %> building photo</label>
      <input type="file" name="building_image" accept="image/jpeg,image/png,image/webp">
      <small style="color: #888;">Max 5 MB. JPG, PNG, or WebP.</small>
    </div>

    <h3 class="ui dividing header">Details</h3>

    <div class="two fields">
      <div class="field">
        <label>Min Age</label>
        <input type="number" name="min_age" value="<%= l.min_age || '' %>" min="0" max="99">
      </div>
      <div class="field">
        <label>Max Age</label>
        <input type="number" name="max_age" value="<%= l.max_age || '' %>" min="0" max="99">
      </div>
    </div>

    <div class="field">
      <label>Eligibility Requirements</label>
      <input type="text" name="eligibility_requirements" value="<%= l.eligibility_requirements || '' %>">
    </div>

    <div class="field">
      <label>Cost / Financial Info</label>
      <input type="text" name="financial_information" value="<%= l.financial_information || '' %>">
    </div>

    <div class="field">
      <label>Languages Offered (comma separated)</label>
      <input type="text" name="languages_offered" value="<%= Array.isArray(l.languages_offered) ? l.languages_offered.join(', ') : (l.languages_offered || '') %>">
    </div>

    <div class="field">
      <label>Next Steps / Intake Instructions</label>
      <textarea name="intake_instructions" rows="2"><%= l.intake_instructions || '' %></textarea>
    </div>

    <div class="ui divider"></div>

    <div style="display: flex; gap: .5em;">
      <button type="submit" class="ui button teal-background" style="flex:1; font-size: 1.1em;">
        <i class="save icon"></i> Save Changes
      </button>
      <a href="/org/dashboard" class="ui button basic" style="font-size: 1.1em;">Cancel</a>
    </div>
  </form>
</div>

<script>
  document.querySelector('select[name="category"]').addEventListener('change', function() {
    var customField = document.getElementById('custom-category-field');
    customField.style.display = this.value === '__custom' ? 'block' : 'none';
  });
</script>
